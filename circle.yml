machine:
  timezone:
    Asia/Tokyo
  ruby:
    version:
      2.3.3
  environment:
    RACK_ENV: test
  services:
    - mysql
dependencies:
  override:
    - bundle install
database:
  override:
    - mv config/database.yml.ci config/database.yml
    - bundle exec rake db:create db:migrate
test:
  override:
    - bundle exec rake spec
  post:
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASS
    - docker build -t itkq/rails5:$CIRCLE_SHA1 .
    - docker push itkq/rails5:$CIRCLE_SHA1

deployment:
  staging:
    branch: master
    commands:
      ecs-cli compose service up
