machine:
  timezone:
    Asia/Tokyo
  ruby:
    version:
      2.3.3
  environment:
    RACK_ENV: test
  services:
    - mysql
    - docker
dependencies:
  pre:
    - bundle install
    - pip install awscli
    - sudo apt-get install -y jq

database:
  override:
    - mv config/database.yml.ci config/database.yml
    - bundle exec rake db:create db:migrate
test:
  override:
    - bundle exec rake spec
  # post:
  #   - docker login -e $DOCKER_EMAIL -u $DOCKER_USERNAME -p $DOCKER_PASS
  #   - docker build --rm=false -f ./Dockerfile.staging -t itkq/rails5:$CIRCLE_SHA1 .
  #   - docker push itkq/rails5:$CIRCLE_SHA1
deployment:
  staging:
    branch: master
    commands:
      - heroku plugins:install heroku-container-tools
      - heroku maintenance:on --app cookgram
      - heroku container:login -v
      - heroku container:push web --app cookgram
      - heorku maintenance:off --app cookgram

